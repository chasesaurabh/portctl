name: Update Homebrew Formula

on:
  push:
    branches: [ main ]

jobs:
  update-brew:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v4
        with:
          version: latest
          install-only: true

      - name: Generate Homebrew formula (snapshot)
        run: |
          set -euo pipefail
          goreleaser release --snapshot --skip-publish

      - name: Create PR in tap with updated formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          set -euo pipefail
          if [ -z "${HOMEBREW_TAP_TOKEN:-}" ]; then
            echo "HOMEBREW_TAP_TOKEN not set, skipping PR creation"
            exit 0
          fi

          TAP=chasesaurabh/homebrew-portctl
          BRANCH=update-portctl-$(date +%s)

          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/${TAP}.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap
          git checkout -b ${BRANCH}
          mkdir -p Formula
          cp ${GITHUB_WORKSPACE}/dist/homebrew/portctl.rb Formula/portctl.rb
          git add Formula/portctl.rb
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git commit -m "chore: update portctl formula from ${GITHUB_REPOSITORY}@${GITHUB_REF#refs/heads/}" || true
          git push https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/${TAP}.git HEAD:refs/heads/${BRANCH}

          # create PR using GitHub CLI (install via script if missing)
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://github.com/cli/cli/releases/latest/download/gh_2.27.0_linux_amd64.tar.gz -o /tmp/gh.tar.gz
            tar -xzf /tmp/gh.tar.gz -C /tmp
            sudo mv /tmp/gh_2.27.0_linux_amd64/bin/gh /usr/local/bin/gh
          fi

          gh auth login --with-token <<< "${HOMEBREW_TAP_TOKEN}"
          gh pr create --title "chore: update portctl formula" --body "Automated update of Homebrew formula from ${GITHUB_REPOSITORY}" --base main --head ${BRANCH} --repo ${TAP}
