name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-brew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.20'
      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          install-only: true

      - name: Generate Homebrew formula (snapshot)
        run: |
          set -euo pipefail
          # --snapshot avoids publishing; explicit --skip-publish is not supported
          goreleaser release --snapshot

      - name: Create PR in tap with updated formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          AUTOMERGE_SHARED_SECRET: ${{ secrets.AUTOMERGE_SHARED_SECRET }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          set -euo pipefail
          if [ -z "${HOMEBREW_TAP_TOKEN:-}" ]; then
            echo "HOMEBREW_TAP_TOKEN not set, skipping PR creation"
            exit 0
          fi

          TAP=chasesaurabh/homebrew-portctl
          BRANCH=update-portctl-$(date +%s)

          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/${TAP}.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap
          git checkout -b ${BRANCH}
          mkdir -p Formula
          cp ${GITHUB_WORKSPACE}/dist/homebrew/portctl.rb Formula/portctl.rb
          git add Formula/portctl.rb
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git commit -m "chore: update portctl formula from ${GITHUB_REPOSITORY}@${GITHUB_REF#refs/heads/}" || true
          git push https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/${TAP}.git HEAD:refs/heads/${BRANCH}

          # create HMAC-signed PR body so the tap can verify origin
          # Payload: <repo>:<commit>
          PAYLOAD="${GITHUB_REPOSITORY}:${GITHUB_SHA}"
          if [ -n "${AUTOMERGE_SHARED_SECRET:-}" ]; then
            SIG=$(printf "%s" "$PAYLOAD" | openssl dgst -sha256 -hmac "${AUTOMERGE_SHARED_SECRET}" -binary | xxd -p -c 256)
          else
            SIG=""
          fi


          PR_BODY="$(printf 'Automated update of Homebrew formula from %s\nAutomerge-Payload: %s\nAutomerge-Signature: %s' "${GITHUB_REPOSITORY}" "${PAYLOAD}" "${SIG}")"
          echo "PR_BODY: $PR_BODY"

          # Robust two-step jq approach for multiline PR body
          PR_PAYLOAD=$(jq -n --arg title "chore: update portctl formula" \
            --arg head "${BRANCH}" \
            --arg base "main" \
            --arg body "" \
            '{title: $title, head: $head, base: $base, body: $body}')
          PR_PAYLOAD=$(echo "$PR_PAYLOAD" | jq --arg body "$PR_BODY" '.body = $body')

          PR_RESP=$(curl -s -X POST \
            -H "Authorization: token ${HOMEBREW_TAP_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${TAP}/pulls \
            -d "$PR_PAYLOAD")

          PR_URL=$(echo "$PR_RESP" | python3 -c 'import sys, json; j=json.load(sys.stdin); print(j.get("html_url",""))')
          if [ -z "$PR_URL" ]; then
            echo "Failed to create PR. Response from API:" >&2
            echo "$PR_RESP" >&2
            exit 1
          fi
          echo "Created PR: $PR_URL"
